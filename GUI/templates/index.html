<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backup/Archive Retrieval</title>
    <style>
	* {
		box-sizing: border-box;
		margin: 0;
		padding: 0;
	}

	body {
		font-family: Arial, sans-serif;
		background-color: #f4f4f9;
		color: #333;
		padding: 20px;
		line-height: 1.6;
	}

	.container {
		display: flex;
		justify-content: space-between;  
		align-items: flex-start; 
	}

	.terapie-list {
		flex: 1;
		max-width: 45%;  
		margin-right: 20px; 
	}

	.calendar-container {
		flex: 1;
		max-width: 50%; 
	}

	.month-switcher {
		display: flex;
		justify-content: space-between;  
		align-items: center;  
		margin-bottom: 10px;  /* Reduced margin to move the buttons closer */
	}

	#currentMonth {
		flex-grow: 2;
		text-align: center;
		font-size: 1.5rem;
		font-weight: bold;
		margin-bottom: 10px;  /* Ensures there is spacing between the title and the calendar */
	}

	.weekdays {
		display: grid;
		grid-template-columns: repeat(7, 1fr);  /* Same as the .calendar */
		text-align: center;  /* Align the text in the center */
		padding: 5px 0;  /* Adjusted padding */
		background-color: #fff;
		font-weight: bold;
		border-bottom: 2px solid #ccc;
	}

	.calendar {
		display: grid;
		grid-template-columns: repeat(7, 1fr);  /* Same structure as weekdays */
		gap: 20px;  /* Adjust the gap as needed */
		padding: 0px;
		background-color: #f9f9f9;
		border-radius: 10px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
	}


	.day {
		position: relative;
		width: 40px;
		height: 40px;
		display: flex;
		justify-content: center;
		align-items: center;
		background-color: #f1f1f1;
		border-radius: 50%;
		border: 1px solid #ccc;
		box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		font-size: 0.9rem;
	}

	.day:hover {
		background-color: #e0e0e0;
		transform: scale(1.05);
	}

	button {
		background-color: #007bff;
		color: white;
		border: none;
		padding: 5px 15px;  
		border-radius: 5px;
		cursor: pointer;
		font-size: 1rem;
		transition: background-color 0.3s ease;
		margin: 0 5px;  /* Added spacing between the buttons */
	}

	button:hover {
		background-color: #0056b3;
	}

	button:disabled {
		background-color: #ccc;
		cursor: not-allowed;
	}


	.day[data-complete="true"] {
		background-color: #aaffaa;  /* Green for completed days */
	}

	.day[data-complete="false"] {
		background-color: #ffaaaa;  /* Red for incomplete days */
	}

	.mini-indicator {
		width: 10px;  /* Smaller size for the indicator */
		height: 10px;
		background: #00ff00;  /* Same green for complete */
		border-radius: 50%;
		position: absolute;
		top: -7px;  /* Adjusts the position outside the day circle */
		right: -7px;
	}

	.mini-indicator.incomplete {
		background: #ff0000;  /* Red for incomplete */
	}

	.day {
		position: relative;  /* Allows positioning the mini-indicator */
		width: 40px;
		height: 40px;
		display: flex;
		justify-content: center;
		align-items: center;
		background-color: #f1f1f1;
		border-radius: 50%;
		border: 1px solid #ccc;
		box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		font-size: 0.9rem;
	}

	.month-switcher {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 20px;
		gap: 10px;
	}

	#currentMonth {
		flex: 2;
		text-align: center;
		font-size: 1.5rem;
		font-weight: bold;
	}
	
	.day.today {
    background-color: #ffff00; /* Yellow highlight */
    border: 2px solid #ffcc00; /* Add a border for emphasis */
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
	}
	

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f4f4f9;
        }

        .up-to-date {
            background-color: #d4edda; /* Green for up-to-date */
        }

        .outdated {
            background-color: #f8d7da; /* Red for outdated */
        }
    </style>
</head>
<body>
    <h1>Backup/Archive Retrieval</h1>

    <div>
        <button id="retrieveButton" onclick="retrieveTerapie()" disabled>Retrieve Latest Terapie</button>
    </div>

    <table id="pdfTable">
        <thead>
            <tr>
                <th>PDF File</th>
                <th>Status</th>
                <th>Last Available Date</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows will be dynamically added here -->
        </tbody>
    </table>

	<div class="container">
		<div class="terapie-list">
			<h2>Available Terapie</h2>
			<ul id="terapieList">
				<!-- Available terapie will be listed here -->
			</ul>
		</div>

		<div class="calendar-container">
			<div class="month-switcher">
				<button id="prevMonth" onclick="changeMonth(-1)">Previous Month</button>
				<h2 id="currentMonth">October 2024</h2> <!-- Add year in the title -->
				<button id="nextMonth" onclick="changeMonth(1)">Next Month</button>
			</div>

			<div class="weekdays">
				<div class="weekday">Mon</div>
				<div class="weekday">Tue</div>
				<div class="weekday">Wed</div>
				<div class="weekday">Thu</div>
				<div class="weekday">Fri</div>
				<div class="weekday">Sat</div>
				<div class="weekday">Sun</div>
			</div>

			<div id="calendarDays" class="calendar">
				<!-- Calendar days will be inserted here dynamically -->
			</div>
		</div>
	</div>


    <script>
        function checkAvailableTerapie() {
            fetch('/check_up_to_date')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#pdfTable tbody');
                    tableBody.innerHTML = ''; // Clear previous list

                    for (let terapie in data) {
                        if (data.hasOwnProperty(terapie)) {
                            const row = document.createElement('tr');
                            const fileCell = document.createElement('td');
                            const statusCell = document.createElement('td');
                            const dateCell = document.createElement('td');

                            fileCell.textContent = terapie;
                            statusCell.textContent = data[terapie].up_to_date ? 'Up to date' : 'Outdated';
                            dateCell.textContent = data[terapie].latest_date || 'Unknown';  // Display the date or 'Unknown' if missing

                            // Apply class for coloring
                            row.classList.add(data[terapie].up_to_date ? 'up-to-date' : 'outdated');

                            row.appendChild(fileCell);
                            row.appendChild(statusCell);
                            row.appendChild(dateCell);
                            tableBody.appendChild(row);
                        }
                    }

                    // Enable the button only if there are any outdated files
                    const allUpToDate = Object.values(data).every(item => item.up_to_date);
                    document.getElementById('retrieveButton').disabled = allUpToDate;
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

	let currentMonth = new Date().getMonth();  // Current month (0-indexed)
	let currentYear = new Date().getFullYear();  // Current year
	let today = new Date();

	function renderCalendar(year, month) {
		const calendarContainer = document.getElementById('calendarDays');
		calendarContainer.innerHTML = '';  // Clear previous calendar

		const firstDayOfMonth = new Date(year, month, 1).getDay();  // Get the day of the week for the 1st of the month
		const adjustedFirstDay = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;  // Adjust so Monday is the first day
		const daysInMonth = new Date(year, month + 1, 0).getDate();  // Get number of days in month

		// Add empty days to align the first day of the month
		for (let i = 0; i < adjustedFirstDay; i++) {
			const emptyDiv = document.createElement('div');
			calendarContainer.appendChild(emptyDiv);  // Append empty divs for spacing
		}

		// Loop through each day of the month
		fetch(`/check_month/${year}/${month + 1}`)
			.then(response => response.json())
			.then(data => {
				for (let i = 1; i <= daysInMonth; i++) {
					const dayDiv = document.createElement('div');
					dayDiv.classList.add('day');
					dayDiv.textContent = i;

					// Check if it's today's date
					if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
						dayDiv.classList.add('today');  // Add the 'today' class for today's date
					}

					// Apply existing logic for complete/incomplete days and mini indicators
					if (data[i]) {
						const dayData = data[i];
						if (dayData.complete) {
							dayDiv.style.backgroundColor = '#aaffaa';  // Green for complete days
						} else {
							dayDiv.style.backgroundColor = '#ffaaaa';  // Red for incomplete days
						}

						// Add mini indicator for 'Mese successivo'
						if (dayData.mese_successivo === "complete") {
							const miniCircle = document.createElement('div');
							miniCircle.classList.add('mini-indicator', 'complete');
							dayDiv.appendChild(miniCircle);
						} else if (dayData.mese_successivo === "incomplete") {
							const miniCircle = document.createElement('div');
							miniCircle.classList.add('mini-indicator', 'incomplete');
							dayDiv.appendChild(miniCircle);
						}
					}

					calendarContainer.appendChild(dayDiv);
				}

				// Update button states for month navigation
				updateMonthNavigation();
			})
			.catch(error => {
				console.error('Error fetching month data:', error);
			});

		// Update the month and year display
		const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
		document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;  // Now includes year
	}

	function changeMonth(delta) {
		currentMonth += delta;
		if (currentMonth < 0) {
			currentMonth = 11;
			currentYear -= 1;
		} else if (currentMonth > 11) {
			currentMonth = 0;
			currentYear += 1;
		}

		// Prevent navigating beyond the current month
		if (currentYear === today.getFullYear() && currentMonth > today.getMonth()) {
			currentMonth = today.getMonth();  // Reset to the current month
		}

		const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
		document.getElementById('currentMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;  // Now includes year
		renderCalendar(currentYear, currentMonth);
	}

         function retrieveTerapie() {
            fetch('/retrieve_terapie', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert('Terapie retrieved: ' + data.message);
                    checkAvailableTerapie(); // Refresh the list after retrieval
                })
                .catch(error => {
                    console.error('Error retrieving Terapie:', error);
                });
        }

	function updateMonthNavigation() {
		// Disable the "Next Month" button if it's the current month
		const nextButton = document.getElementById('nextMonth');
		if (currentYear === today.getFullYear() && currentMonth >= today.getMonth()) {
			nextButton.disabled = true;  // Disable next month button
		} else {
			nextButton.disabled = false;  // Enable next month button
		}
	}

	// Initialize
	checkAvailableTerapie();  // Call this function during page load to populate the Terapie list
	renderCalendar(currentYear, currentMonth);
    </script>
</body>
</html>
